@page "/bookmarks"
@inject BookmarkService BookmarkService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@implements IDisposable

<PageTitle>Đánh dấu - Code Magic</PageTitle>

<div class="bookmarks-page">
    <div class="bookmarks-header">
        <h1>
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
            </svg>
            Đánh dấu của tôi
        </h1>
        <p class="bookmarks-count">@bookmarks.Count chương đã đánh dấu</p>
    </div>

    @if (bookmarks.Any())
    {
        <div class="bookmarks-actions">
            <button class="btn-clear-all" @onclick="ClearAll">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
                Xóa tất cả
            </button>
        </div>

        <div class="bookmarks-grouped">
            @foreach (var group in bookmarksByBook)
            {
                <div class="bookmark-group">
                    <div class="group-header">
                        <a href="book/@group.Key.ToLower().Replace(" ", "-")" class="group-title">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                            </svg>
                            @group.Key
                        </a>
                        <span class="group-count">@group.Count() chương</span>
                    </div>
                    <div class="group-items">
                        @foreach (var bookmark in group.OrderByDescending(b => b.AddedAt))
                        {
                            <div class="bookmark-card">
                                <a href="@GetBookmarkUrl(bookmark)" class="bookmark-link" @onclick="() => NavigateToBookmark(bookmark)" @onclick:preventDefault>
                                    <div class="bookmark-info">
                                        <h3>@bookmark.Title</h3>
                                        <div class="bookmark-meta">
                                            <span class="bookmark-date">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <circle cx="12" cy="12" r="10"/>
                                                    <polyline points="12 6 12 12 16 14"/>
                                                </svg>
                                                Đánh dấu: @bookmark.AddedAt.ToString("dd/MM/yyyy HH:mm")
                                            </span>
                                            @if (bookmark.LastReadAt.HasValue)
                                            {
                                                <span class="bookmark-last-read">
                                                    Đọc lần cuối: @bookmark.LastReadAt.Value.ToString("dd/MM/yyyy HH:mm")
                                                </span>
                                            }
                                            @if (bookmark.ScrollPosition > 0)
                                            {
                                                <span class="bookmark-position">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M12 22V8"/>
                                                        <path d="m5 12 7-7 7 7"/>
                                                    </svg>
                                                    Có vị trí đọc đã lưu
                                                </span>
                                            }
                                        </div>
                                    </div>
                                </a>
                                <button class="bookmark-remove" @onclick="() => RemoveBookmark(bookmark.Slug)" title="Xóa đánh dấu">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M18 6L6 18M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="no-bookmarks">
            <div class="no-bookmarks-icon">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                </svg>
            </div>
            <h2>Chưa có đánh dấu nào</h2>
            <p>Khi đọc chương, nhấn nút đánh dấu ở góc phải màn hình để lưu lại vị trí đọc.</p>
            <a href="book" class="btn-browse">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                </svg>
                Xem thư viện sách
            </a>
        </div>
    }
</div>

@code {
    private List<BookmarkItem> bookmarks = new();
    private IEnumerable<IGrouping<string, BookmarkItem>> bookmarksByBook =>
        bookmarks.GroupBy(b => b.BookName);

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await BookmarkService.InitializeAsync();
            bookmarks = BookmarkService.Bookmarks.ToList();
            BookmarkService.OnBookmarksChanged += OnBookmarksChanged;
            StateHasChanged();
        }
    }

    private void OnBookmarksChanged()
    {
        bookmarks = BookmarkService.Bookmarks.ToList();
        InvokeAsync(StateHasChanged);
    }

    private string GetBookmarkUrl(BookmarkItem bookmark)
    {
        return bookmark.Slug.TrimStart('/');
    }

    private async Task NavigateToBookmark(BookmarkItem bookmark)
    {
        var url = bookmark.Slug.TrimStart('/');

        if (bookmark.ScrollPosition > 0)
        {
            // Navigate then scroll to position
            Navigation.NavigateTo(url);
            await Task.Delay(100); // Wait for page load
            await JS.InvokeVoidAsync("window.scrollTo", 0, bookmark.ScrollPosition);
        }
        else
        {
            Navigation.NavigateTo(url);
        }
    }

    private async Task RemoveBookmark(string slug)
    {
        await BookmarkService.RemoveBookmarkAsync(slug);
    }

    private async Task ClearAll()
    {
        await BookmarkService.ClearAllAsync();
    }

    public void Dispose()
    {
        BookmarkService.OnBookmarksChanged -= OnBookmarksChanged;
    }
}
