@page "/bookmarks"

<PageTitle>Đánh dấu - Code Magic</PageTitle>

<div class="bookmarks-page">
    <div class="bookmarks-header">
        <h1>
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
            </svg>
            Đánh dấu của tôi
        </h1>
        <p class="bookmarks-count" id="bookmarks-count">0 chương đã đánh dấu</p>
    </div>

    <div id="bookmarks-content">
        <!-- Content will be rendered by JavaScript -->
        <div class="no-bookmarks">
            <div class="no-bookmarks-icon">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                </svg>
            </div>
            <h2>Chưa có đánh dấu nào</h2>
            <p>Khi đọc chương, nhấn nút đánh dấu ở góc phải màn hình để lưu lại vị trí đọc.</p>
            <a href="book" class="btn-browse">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                </svg>
                Xem thư viện sách
            </a>
        </div>
    </div>
</div>

<script>
    function renderBookmarksPage() {
        var bookmarks = BookmarkManager.getAll();
        var countEl = document.getElementById('bookmarks-count');
        var contentEl = document.getElementById('bookmarks-content');

        if (!contentEl) return;

        if (countEl) {
            countEl.textContent = bookmarks.length + ' chương đã đánh dấu';
        }

        if (bookmarks.length === 0) {
            contentEl.innerHTML = getNoBookmarksHtml();
            return;
        }

        // Group bookmarks by book
        var groups = {};
        bookmarks.forEach(function(b) {
            var bookName = b.bookName || 'Khác';
            if (!groups[bookName]) groups[bookName] = [];
            groups[bookName].push(b);
        });

        var html = '<div class="bookmarks-actions">' +
            '<button class="btn-clear-all" onclick="clearAllBookmarks()">' +
            '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
            '<polyline points="3 6 5 6 21 6"/>' +
            '<path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>' +
            '</svg> Xóa tất cả</button></div>';

        html += '<div class="bookmarks-grouped">';

        Object.keys(groups).forEach(function(bookName) {
            var group = groups[bookName];
            var bookSlug = bookName.toLowerCase().replace(/ /g, '-');

            html += '<div class="bookmark-group">' +
                '<div class="group-header">' +
                '<a href="book/' + bookSlug + '" class="group-title">' +
                '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
                '<path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>' +
                '<path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>' +
                '</svg> ' + escapeHtml(bookName) + '</a>' +
                '<span class="group-count">' + group.length + ' chương</span>' +
                '</div><div class="group-items">';

            // Sort by addedAt descending
            group.sort(function(a, b) {
                return new Date(b.addedAt) - new Date(a.addedAt);
            });

            group.forEach(function(bookmark) {
                var url = bookmark.slug.replace(/^\//, '');
                var addedDate = formatDate(bookmark.addedAt);
                var lastReadDate = bookmark.lastReadAt ? formatDate(bookmark.lastReadAt) : null;

                html += '<div class="bookmark-card">' +
                    '<a href="' + url + '" class="bookmark-link" onclick="navigateToBookmark(\'' + escapeJs(bookmark.slug) + '\'); return false;">' +
                    '<div class="bookmark-info">' +
                    '<h3>' + escapeHtml(bookmark.title) + '</h3>' +
                    '<div class="bookmark-meta-wrap">' +
                    '<div class="meta-item"><span class="meta-label">Đã thêm:</span> ' + addedDate + '</div>';

                if (lastReadDate) {
                    html += '<div class="meta-item"><span class="meta-label">Đọc lần cuối:</span> ' + lastReadDate + '</div>';
                }

                if (bookmark.scrollPosition > 0) {
                    html += '<div class="meta-item"><span class="meta-label">Vị trí:</span> ' + Math.round(bookmark.scrollPosition) + 'px</div>';
                }

                html += '</div></div></a>' +
                    '<button class="btn-remove-modern" onclick="removeBookmarkFromPage(\'' + escapeJs(bookmark.slug) + '\')" title="Xóa đánh dấu">' +
                    '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
                    '<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>';
            });

            html += '</div></div>';
        });

        html += '</div>';
        contentEl.innerHTML = html;
    }

    function getNoBookmarksHtml() {
        return '<div class="no-bookmarks">' +
            '<div class="no-bookmarks-icon">' +
            '<svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">' +
            '<path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>' +
            '</svg></div>' +
            '<h2>Chưa có đánh dấu nào</h2>' +
            '<p>Khi đọc chương, nhấn nút đánh dấu ở góc phải màn hình để lưu lại vị trí đọc.</p>' +
            '<a href="book" class="btn-browse">' +
            '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
            '<path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>' +
            '<path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>' +
            '</svg> Xem thư viện sách</a></div>';
    }

    function navigateToBookmark(slug) {
        if (typeof BookmarkManager !== 'undefined') {
            BookmarkManager.navigateTo(slug);
        } else {
            window.location.href = slug;
        }
    }

    function removeBookmarkFromPage(slug) {
        BookmarkManager.remove(slug);
        renderBookmarksPage();
    }

    function clearAllBookmarks() {
        if (confirm('Bạn có chắc muốn xóa tất cả đánh dấu?')) {
            BookmarkManager.clearAll();
            renderBookmarksPage();
        }
    }

    function formatDate(dateStr) {
        try {
            var d = new Date(dateStr);
            var day = ('0' + d.getDate()).slice(-2);
            var month = ('0' + (d.getMonth() + 1)).slice(-2);
            var year = d.getFullYear();
            var hours = ('0' + d.getHours()).slice(-2);
            var mins = ('0' + d.getMinutes()).slice(-2);
            return day + '/' + month + '/' + year + ' ' + hours + ':' + mins;
        } catch (e) {
            return dateStr;
        }
    }

    function escapeHtml(str) {
        if (!str) return '';
        return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function escapeJs(str) {
        if (!str) return '';
        return String(str).replace(/\\/g, '\\\\').replace(/'/g, "\\'");
    }

    // Render on page load
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof BookmarkManager !== 'undefined') {
            renderBookmarksPage();
        }
    });

    // Also render if BookmarkManager is loaded later
    if (typeof BookmarkManager !== 'undefined') {
        renderBookmarksPage();
    }

    // Listen for changes
    document.addEventListener('bookmarksChanged', function() {
        renderBookmarksPage();
    });
</script>
