@page "/tags/{TagName}"
@page "/tags"
@using Blake.Types
@using Blake.Generated
@inject NavigationManager Navigation

<PageTitle>Posts tagged @GetTitle()</PageTitle>

<div class="tags-page">
    <div class="tags-header">
        <h1>
            <span class="tag-icon">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/>
                    <line x1="7" y1="7" x2="7.01" y2="7"/>
                </svg>
            </span>
            @GetTitle()
        </h1>
        <p class="tags-count">@filteredPosts.Count() bài viết</p>
    </div>

    @if (_selectedTags.Any())
    {
        <div class="selected-tags">
            @foreach (var tag in _selectedTags)
            {
                <button type="button" class="selected-tag" @onclick="() => RemoveTag(tag)">
                    #@tag
                    <span class="remove-icon">&times;</span>
                </button>
            }
            <button type="button" class="tag-clear-btn" @onclick="ClearAll">Bỏ chọn tất cả</button>
        </div>
    }

    <div class="posts-list">
        @if (filteredPosts.Any())
        {
            @foreach (var post in filteredPosts)
            {
                <a href="@post.Slug.TrimStart('/')" class="post-card">
                    <div class="post-card-content">
                        <h2 class="post-title">@post.Title</h2>
                        @if (!string.IsNullOrEmpty(post.Description))
                        {
                            <p class="post-description">@post.Description</p>
                        }
                        <div class="post-meta">
                            <span class="post-date">@post.Date</span>
                            @if (post.Tags.Any())
                            {
                                <div class="post-tags">
                                    @foreach (var tag in post.Tags.Take(4))
                                    {
                                        <span class="tag-badge">#@tag</span>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                </a>
            }
        }
        else
        {
            <div class="no-posts">
                <p>Không có bài viết phù hợp </p>
                <a href="" class="btn-back">Trở về Trang chủ</a>
            </div>
        }
    </div>

    <div class="all-tags">
        <h3>Chọn chủ đề</h3>
        <div class="tag-list">
            @foreach (var tag in allTags)
            {
                <button type="button"
                        class="tag-link @(IsSelected(tag) ? "active" : "")"
                        @onclick="() => ToggleTag(tag)">
                    #@tag
                </button>
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public string? TagName { get; set; }

    [SupplyParameterFromQuery(Name = "t")]
    public string[]? QueryTags { get; set; }

    private HashSet<string> _selectedTags = new(StringComparer.OrdinalIgnoreCase);
    private IEnumerable<PageModel> filteredPosts = Enumerable.Empty<PageModel>();
    private List<string> allTags = new();

    protected override void OnParametersSet()
    {
        _selectedTags.Clear();

        // Support both /tags/tagname and /tags?t=tag1&t=tag2
        if (!string.IsNullOrEmpty(TagName))
        {
            _selectedTags.Add(TagName);
        }

        if (QueryTags != null)
        {
            foreach (var tag in QueryTags)
            {
                if (!string.IsNullOrEmpty(tag))
                    _selectedTags.Add(tag);
            }
        }

        var allPages = GeneratedContentIndex.GetPages().Where(p => !p.Draft);

        if (_selectedTags.Any())
        {
            // OR logic: bài viết chỉ cần có 1 trong các tags được chọn
            filteredPosts = allPages
                .Where(p => p.Tags.Any(postTag =>
                    _selectedTags.Any(selectedTag => postTag.Equals(selectedTag, StringComparison.OrdinalIgnoreCase))))
                .OrderByDescending(p => p.Date);
        }
        else
        {
            filteredPosts = allPages.OrderByDescending(p => p.Date);
        }

        allTags = allPages
            .SelectMany(p => p.Tags)
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .OrderBy(t => t)
            .ToList();
    }

    private string GetTitle()
    {
        if (!_selectedTags.Any()) return "Các bài viết";
        if (_selectedTags.Count == 1) return $"#{_selectedTags.First()}";
        return string.Join(", ", _selectedTags.Select(t => $"#{t}"));
    }

    private bool IsSelected(string tag) => _selectedTags.Contains(tag);

    private void ToggleTag(string tag)
    {
        if (_selectedTags.Contains(tag))
            _selectedTags.Remove(tag);
        else
            _selectedTags.Add(tag);

        NavigateToTags();
    }

    private void RemoveTag(string tag)
    {
        _selectedTags.Remove(tag);
        NavigateToTags();
    }

    private void ClearAll()
    {
        _selectedTags.Clear();
        Navigation.NavigateTo("/tags");
    }

    private void NavigateToTags()
    {
        if (!_selectedTags.Any())
        {
            Navigation.NavigateTo("/tags");
            return;
        }

        var query = string.Join("&", _selectedTags.Select(t => $"t={Uri.EscapeDataString(t)}"));
        Navigation.NavigateTo($"/tags?{query}");
    }
}
