@page "/print-book/{BookSlug}"
@using Blake.Types
@using Blake.Generated
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>In sách - @bookName</PageTitle>

<div class="print-book-page">
    @if (isLoading)
    {
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p>Đang tải nội dung sách...</p>
            <p class="loading-progress">@loadedCount / @totalCount chương</p>
        </div>
    }
    else if (!contentLoaded)
    {
        <div class="print-header">
            <h1>@bookName</h1>
            <p>@chapters.Length chương</p>
            <div class="print-actions">
                <button class="btn-print" @onclick="LoadAndPrint">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 6 2 18 2 18 9" />
                        <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" />
                        <rect x="6" y="14" width="12" height="8" />
                    </svg>
                    Tải và in sách
                </button>
                <a href="book/@BookSlug" class="btn-back">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7" />
                    </svg>
                    Quay lại
                </a>
            </div>
        </div>

        <div class="print-preview">
            <h2>Nội dung sẽ in</h2>
            <div class="chapters-preview">
                @for (int i = 0; i < chapters.Length; i++)
                {
                    var chapter = chapters[i];
                    var isNumberedChapter = chapter.Slug.Contains("/chapter-", StringComparison.OrdinalIgnoreCase);
                    <div class="preview-item">
                        @if (isNumberedChapter)
                        {
                            <span class="preview-number">Chương @(GetChapterNumber(chapter))</span>
                        }
                        <span class="preview-title">@chapter.Title</span>
                    </div>
                }
            </div>
        </div>
    }
    else
    {
        <div class="print-header no-print">
            <h1>@bookName</h1>
            <p>@chapters.Length chương - Sẵn sàng in</p>
            <div class="print-actions">
                <button class="btn-print" @onclick="ExecutePrint">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 6 2 18 2 18 9" />
                        <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" />
                        <rect x="6" y="14" width="12" height="8" />
                    </svg>
                    In ngay
                </button>
                <a href="book/@BookSlug" class="btn-back">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7" />
                    </svg>
                    Quay lại
                </a>
            </div>
        </div>

        <div class="print-content" id="print-content">
            <!-- Book cover -->
            <div class="book-cover print-only">
                <h1>@bookName</h1>
                <p class="book-meta">@chapters.Length chương</p>
                <p class="book-source">Code Magic - Dịch sách công nghệ</p>
            </div>

            <!-- Table of Contents -->
            <div class="print-toc">
                <h2>Mục lục</h2>
                <ul>
                    @for (int i = 0; i < chapters.Length; i++)
                    {
                        var chapter = chapters[i];
                        var isNumberedChapter = chapter.Slug.Contains("/chapter-", StringComparison.OrdinalIgnoreCase);
                        <li>
                            @if (isNumberedChapter)
                            {
                                <span class="toc-number">Chương @(GetChapterNumber(chapter))</span>
                            }
                            <span class="toc-title">@chapter.Title</span>
                        </li>
                    }
                </ul>
            </div>

            <!-- Chapter contents -->
            @foreach (var chapter in chapters)
            {
                var isNumberedChapter = chapter.Slug.Contains("/chapter-", StringComparison.OrdinalIgnoreCase);
                <div class="print-chapter">
                    <div class="chapter-header">
                        @if (isNumberedChapter)
                        {
                            <span class="chapter-label">Chương @(GetChapterNumber(chapter))</span>
                        }
                        <h1 class="chapter-title">@chapter.Title</h1>
                    </div>
                    <div class="chapter-content" id="chapter-@chapter.Slug.Replace("/", "-").TrimStart('-')">
                        @if (chapterContents.TryGetValue(chapter.Slug, out var content))
                        {
                            @((MarkupString)content)
                        }
                        else
                        {
                            <p class="content-error">Đang tải nội dung...</p>
                        }
                    </div>
                </div>
            }
        </div>
    }
</div>

<!-- Hidden iframe for loading content -->
<iframe id="content-loader" style="display:none; position:absolute; left:-9999px;"></iframe>

@code {
    [Parameter]
    public string? BookSlug { get; set; }

    private string bookName = "";
    private PageModel[] chapters = Array.Empty<PageModel>();
    private Dictionary<string, string> chapterContents = new();
    private bool isLoading = false;
    private bool contentLoaded = false;
    private int loadedCount = 0;
    private int totalCount = 0;

    protected override void OnParametersSet()
    {
        if (string.IsNullOrEmpty(BookSlug))
        {
            Navigation.NavigateTo("book");
            return;
        }

        var allPages = GeneratedContentIndex.GetPages().Where(p => !p.Draft);

        chapters = allPages
        .Where(p => p.Tags.Any(t =>
        t.ToLower().Replace(" ", "-").Equals(BookSlug, StringComparison.OrdinalIgnoreCase) ||
        t.Equals(BookSlug, StringComparison.OrdinalIgnoreCase)))
        .OrderBy(p => p.Date)
        .ToArray();

        if (chapters.Any())
        {
            bookName = chapters.First().Tags.First();
        }

        totalCount = chapters.Length;
    }

    private async Task LoadAndPrint()
    {
        isLoading = true;
        loadedCount = 0;
        StateHasChanged();

        try
        {
            var baseUri = Navigation.BaseUri.TrimEnd('/');

            foreach (var chapter in chapters)
            {
                try
                {
                    var url = $"{baseUri}{chapter.Slug}";
                    var content = await JS.InvokeAsync<string>("loadChapterContent", url);

                    if (!string.IsNullOrEmpty(content))
                    {
                        chapterContents[chapter.Slug] = content;
                    }
                    else
                    {
                        chapterContents[chapter.Slug] = "<p class='content-error'>Không thể tải nội dung chương này.</p>";
                    }

                    loadedCount++;
                    StateHasChanged();
                }
                catch (Exception ex)
                {
                    chapterContents[chapter.Slug] = $"<p class='content-error'>Lỗi: {ex.Message}</p>";
                    loadedCount++;
                    StateHasChanged();
                }
            }

            contentLoaded = true;
            // Let Blazor render the injected content, then trigger MathJax typesetting
            StateHasChanged();
            await Task.Yield();
            try
            {
                await JS.InvokeVoidAsync("printbookTypeset");
            }
            catch { }
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private int GetChapterNumber(PageModel chapter)
    {
        var slug = chapter.Slug.ToLower();
        var match = System.Text.RegularExpressions.Regex.Match(slug, @"chapter-(\d+)");
        if (match.Success && int.TryParse(match.Groups[1].Value, out var num))
        {
            return num;
        }
        return 0;
    }

    private async Task ExecutePrint()
    {
        await JS.InvokeVoidAsync("window.print");
    }
}