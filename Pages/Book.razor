@page "/book/{BookSlug}"
@page "/book"
@using Blake.Types
@using Blake.Generated
@inject NavigationManager Navigation

<PageTitle>@GetTitle()</PageTitle>

<div class="book-page">
    <div class="book-header">
        <h1>
            <span class="book-icon">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" />
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" />
                </svg>
            </span>
            @GetTitle()
        </h1>
        @if (!string.IsNullOrEmpty(BookSlug))
        {
            <p class="chapters-count">@chaptersArray.Length chương</p>
        }
        else
        {
            <p class="chapters-count">@allBooks.Sum(b => b.Count) chương</p>
        }
    </div>

    @if (!string.IsNullOrEmpty(BookSlug))
    {
        @if (chapters.Any())
        {
            <div class="book-actions">
                <div class="reading-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="reading-progress-fill" style="width: 0%"></div>
                    </div>
                    <span class="progress-text" id="reading-progress-text">Đang tải...</span>
                </div>
                <div class="action-buttons">
                    <a id="continue-reading-btn" href="@(chapterPages.FirstOrDefault()?.Slug.TrimStart('/') ?? "")" class="btn-action btn-continue" style="display: none;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="5 3 19 12 5 21 5 3" />
                        </svg>
                        Tiếp tục đọc
                    </a>
                    <button class="btn-action btn-bookmark" 
                        id="book-bookmark-btn"
                        data-bookmark-slug="@GetBookBookmarkSlug()"
                        onclick="toggleBookBookmark('@EscapeJs(GetBookBookmarkSlug())', '@EscapeJs(GetTitle())')"
                        title="Đánh dấu sách">
                        <svg class="bookmark-icon-empty" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z" />
                        </svg>
                        <svg class="bookmark-icon-filled" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" style="display: none;">
                            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z" />
                        </svg>
                    </button>
                    <a href="print-book/@BookSlug" class="btn-action btn-print" title="In toàn bộ sách">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 6 2 18 2 18 9" />
                            <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" />
                            <rect x="6" y="14" width="12" height="8" />
                        </svg>
                        <span>In sách</span>
                    </a>
                </div>
            </div>
        }
        <div class="chapters-list">
            @if (chapters.Any())
            {
                @* Render non-chapter pages (e.g., forward) first without chapter numbering *@
                @foreach (var page in otherPages)
                {
                    <a href="@(page.Slug.TrimStart('/'))" class="chapter-card">
                        <div class="chapter-card-content">
                            <h2 class="chapter-title">@(page.Title)</h2>
                            @if (!string.IsNullOrEmpty(page.Description))
                            {
                                <p class="chapter-description">@(page.Description)</p>
                            }
                            <div class="chapter-meta">
                                <span class="chapter-date">@(((DateTime)page.Date!).ToString("dd/MM/yyyy"))</span>
                            </div>
                        </div>
                    </a>
                }

                @* Then render actual numbered chapters *@
                @for (int i = 0; i < chapterPages.Length; i++)
                {
                    var chapter = chapterPages[i];
                    var chapterNumber = i + 1;
                    <a href="@chapter.Slug.TrimStart('/')" class="chapter-card">
                        <div class="chapter-card-content">
                            <span class="chapter-number">Chương @chapterNumber</span>
                            <h2 class="chapter-title">@chapter.Title</h2>
                            @if (!string.IsNullOrEmpty(chapter.Description))
                            {
                                <p class="chapter-description">@chapter.Description</p>
                            }
                            <div class="chapter-meta">
                                <span class="chapter-date">@(((DateTime)chapter.Date!).ToString("dd/MM/yyyy"))</span>
                            </div>
                        </div>
                    </a>
                }
            }
            else
            {
                <div class="no-chapters">
                    <p>Chưa có chương nào</p>
                    <a href="" class="btn-back">Trở về Trang chủ</a>
                </div>
            }
        </div>
    }
    else
    {
        <div class="all-books">
            <h3>Tất cả sách</h3>
            <div class="books-list">
                @foreach (var book in allBooks)
                {
                    <a href="book/@book.Slug" class="book-link">
                        <span class="book-name">@book.Name</span>
                        <span class="book-count">@book.Count chương</span>
                    </a>
                }
            </div>
        </div>
    }
</div>

@if (!string.IsNullOrEmpty(BookSlug))
{
    <!-- Chapter data for JavaScript -->
    <script id="book-chapters-data" type="application/json">
    @(new MarkupString(System.Text.Json.JsonSerializer.Serialize(chaptersArray.Select(c => c.Slug))))
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            initBookPage('@BookSlug');
        });

        function initBookPage(bookSlug) {
            var chaptersData = JSON.parse(document.getElementById('book-chapters-data').textContent || '[]');
            var totalChapters = chaptersData.length;
            
            // Load reading progress
            var readChapters = [];
            try {
                var data = localStorage.getItem('reading_progress_' + bookSlug);
                if (data) {
                    readChapters = JSON.parse(data) || [];
                }
            } catch (e) {}

            var readCount = chaptersData.filter(function(slug) {
                return readChapters.indexOf(slug) !== -1;
            }).length;

            var progressPercent = totalChapters > 0 ? Math.round((readCount / totalChapters) * 100) : 0;

            var progressFill = document.getElementById('reading-progress-fill');
            var progressText = document.getElementById('reading-progress-text');
            
            if (progressFill) progressFill.style.width = progressPercent + '%';
            if (progressText) progressText.textContent = 'Đã đọc ' + readCount + '/' + totalChapters + ' chương (' + progressPercent + '%)';

            // Find last read chapter from bookmarks
            var bookmarks = [];
            try {
                var bmData = localStorage.getItem('bookmarks');
                if (bmData) bookmarks = JSON.parse(bmData) || [];
            } catch (e) {}

            var lastReadSlug = null;
            var lastReadTime = null;
            bookmarks.forEach(function(b) {
                if (chaptersData.indexOf(b.slug) !== -1) {
                    var readAt = b.lastReadAt || b.addedAt;
                    if (!lastReadTime || readAt > lastReadTime) {
                        lastReadTime = readAt;
                        lastReadSlug = b.slug;
                    }
                }
            });

            // If no bookmark, find first unread chapter
            if (!lastReadSlug && chaptersData.length > 0) {
                for (var i = 0; i < chaptersData.length; i++) {
                    if (readChapters.indexOf(chaptersData[i]) === -1) {
                        lastReadSlug = chaptersData[i];
                        break;
                    }
                }
                if (!lastReadSlug) lastReadSlug = chaptersData[0];
            }

            var continueBtn = document.getElementById('continue-reading-btn');
            if (continueBtn && lastReadSlug) {
                continueBtn.href = lastReadSlug.replace(/^\//, '');
                continueBtn.style.display = 'inline-flex';
            }

            // Update bookmark button state
            updateBookBookmarkState();
        }

        function updateBookBookmarkState() {
            var btn = document.getElementById('book-bookmark-btn');
            if (!btn) return;
            var slug = btn.dataset.bookmarkSlug;
            var isBookmarked = BookmarkManager.isBookmarked(slug);
            
            var emptyIcon = btn.querySelector('.bookmark-icon-empty');
            var filledIcon = btn.querySelector('.bookmark-icon-filled');
            
            if (emptyIcon) emptyIcon.style.display = isBookmarked ? 'none' : 'block';
            if (filledIcon) filledIcon.style.display = isBookmarked ? 'block' : 'none';
            btn.title = isBookmarked ? 'Bỏ đánh dấu sách' : 'Đánh dấu sách';
        }

        function toggleBookBookmark(slug, title) {
            BookmarkManager.toggle(slug, title, title);
            updateBookBookmarkState();
        }
    </script>
}

@code {
    [Parameter]
    public string? BookSlug { get; set; }

    private IEnumerable<PageModel> chapters = Enumerable.Empty<PageModel>();
    private PageModel[] chaptersArray = Array.Empty<PageModel>();
    private PageModel[] chapterPages = Array.Empty<PageModel>();
    private PageModel[] otherPages = Array.Empty<PageModel>();
    private List<BookSummary> allBooks = new();

    private record BookSummary(string Name, string Slug, int Count);

    protected override void OnParametersSet()
    {
        var allPages = GeneratedContentIndex.GetPages().Where(p => !p.Draft);

        if (!string.IsNullOrEmpty(BookSlug))
        {
            chapters = allPages
                .Where(p => p.Tags.Any(t =>
                    t.ToLower().Replace(" ", "-").Equals(BookSlug, StringComparison.OrdinalIgnoreCase) ||
                    t.Equals(BookSlug, StringComparison.OrdinalIgnoreCase)))
                .OrderBy(p => p.Date);
            chaptersArray = chapters.ToArray();

            // Separate actual chapter pages (slug contains '/chapter-') from other pages like forward/preface
            chapterPages = chaptersArray.Where(c => c.Slug.Contains("/chapter-", StringComparison.OrdinalIgnoreCase))
                .OrderBy(c => c.Slug) // ensure chapter order by slug (chapter-1, chapter-2...)
                .ToArray();

            otherPages = chaptersArray.Except(chapterPages).ToArray();
        }

        allBooks = allPages
            .Where(p => p.Tags.Any())
            .GroupBy(p => p.Tags.First(), StringComparer.OrdinalIgnoreCase)
            .Select(g => new BookSummary(
                g.Key,
                g.Key.ToLower().Replace(" ", "-"),
                g.Count()))
            .OrderBy(b => b.Name)
            .ToList();
    }

    private string GetBookBookmarkSlug()
    {
        return string.IsNullOrEmpty(BookSlug) ? "/book" : $"/book/{BookSlug}";
    }

    private string GetTitle()
    {
        if (string.IsNullOrEmpty(BookSlug)) return "Thư viện sách";

        var matchingBook = allBooks.FirstOrDefault(b =>
            b.Slug.Equals(BookSlug, StringComparison.OrdinalIgnoreCase));

        return matchingBook?.Name ?? BookSlug;
    }

    private string EscapeJs(string input)
    {
        if (string.IsNullOrEmpty(input)) return "";
        return input.Replace("\\", "\\\\").Replace("'", "\\'").Replace("\n", "\\n").Replace("\r", "");
    }
}