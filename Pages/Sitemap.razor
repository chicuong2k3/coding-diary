@page "/sitemap"
@using Blake.Types
@using Blake.Generated

<PageTitle>Sitemap - Code Magic</PageTitle>

<div class="sitemap-page">
    <h1>Sitemap</h1>
    <p class="sitemap-desc">Danh sách tất cả các trang trên website.</p>

    <section class="sitemap-section">
        <h2>Trang chính</h2>
        <ul class="sitemap-list">
            <li><a href="">Trang chủ</a></li>
            <li><a href="book">Thư viện sách</a></li>
            <li><a href="about">Giới thiệu</a></li>
            <li><a href="sitemap">Sitemap</a></li>
        </ul>
    </section>

    <section class="sitemap-section">
        <h2>Sách (@allBooks.Count())</h2>
        <div class="sitemap-tags">
            @foreach (var book in allBooks)
            {
                <a href="book/@book.Slug" class="sitemap-tag">
                    @book.Name <span>(@book.Count chương)</span>
                </a>
            }
        </div>
    </section>

    <section class="sitemap-section">
        <h2>Tất cả chương (@allChapters.Count())</h2>
        <ul class="sitemap-list">
            @foreach (var chapter in allChapters)
            {
                <li>
                    <a href="@chapter.Slug.TrimStart('/')">@chapter.Title</a>
                    <span class="sitemap-date">@(((DateTime)chapter.Date!).ToString("dd/MM/yyyy"))</span>
                </li>
            }
        </ul>
    </section>
</div>

@code {
    private IEnumerable<PageModel> allChapters = Enumerable.Empty<PageModel>();
    private List<BookInfo> allBooks = new();

    protected override void OnInitialized()
    {
        allChapters = GeneratedContentIndex.GetPages()
            .Where(p => !p.Draft)
            .OrderByDescending(p => p.Date);

        allBooks = allChapters
            .Where(p => p.Tags.Any())
            .GroupBy(p => p.Tags.First(), StringComparer.OrdinalIgnoreCase)
            .Select(g => new BookInfo {
                Name = g.Key,
                Slug = g.Key.ToLower().Replace(" ", "-"),
                Count = g.Count()
            })
            .OrderByDescending(b => b.Count)
            .ThenBy(b => b.Name)
            .ToList();
    }

    private class BookInfo
    {
        public string Name { get; set; } = "";
        public string Slug { get; set; } = "";
        public int Count { get; set; }
    }
}
