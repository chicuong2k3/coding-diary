@page "/blog/blazor-auth-phan-1"


<PageTitle>My first test page 3</PageTitle>

<div class="content">
    <h1>My first test page 3</h1>

    <p>Authentication lÃ  tÃ­nh nÄƒng mÃ  gáº§n nhÆ° project nÃ o cÅ©ng cÃ³.
MÃ  tháº­t ra háº§u háº¿t chÃºng ta chá»‰ cáº§n login cháº¡y Ä‘Æ°á»£c lÃ  xong.
Template cÃ³ sáºµn, copy vÃ i dÃ²ng code, tháº¥y form Ä‘Äƒng nháº­p hiá»‡n lÃªn, login thÃ nh cÃ´ng tháº¿
lÃ  xong pháº§n auth, chuyá»ƒn qua lÃ m máº¥y tÃ­nh nÄƒng &quot;xá»‹n&quot; hÆ¡n.</p>
<p>VÃ  má»i thá»© váº«n á»•n... cho Ä‘áº¿n khi khÃ´ng cÃ²n á»•n ná»¯a.</p>
<p>Má»™t buá»•i tá»‘i, team tÃ´i pháº£i vá»™i vÃ ng reset access token
sau khi phÃ¡t hiá»‡n token ná»™i bá»™ bá»‹ lá»™ ra ngoÃ i
chá»‰ vÃ¬ lÆ°u chÃºng trong <code>localStorage</code> cho Ä‘Æ¡n giáº£n.
Hacker chá»‰ cáº§n cáº§m token Ä‘Ã³ lÃ  cÃ³ thá»ƒ truy cáº­p tháº³ng vÃ o há»‡ thá»‘ng.</p>
<p>Náº¿u báº¡n tá»«ng lÃ m app thuáº§n SPA vá»›i React, Angular hay Blazor WebAssembly
thÃ¬ báº¡n Ä‘ang Ä‘á»‘i máº·t vá»›i cÃ¹ng má»™t váº¥n Ä‘á»: token náº±m á»Ÿ phÃ­a client mÃ  client thÃ¬ khÃ´ng an toÃ n.</p>
<p>Authentication lÃ  cáº£ má»™t há»‡ thá»‘ng phá»‘i há»£p giá»¯a frontend, backend, cookie, token vÃ  browser.
Chá»‰ cáº§n xá»­ lÃ½ sai má»™t bÆ°á»›c thÃ´i lÃ  Ä‘á»§ Ä‘á»ƒ toang cáº£ há»‡ thá»‘ng.</p>
<h1 id="authentication-trong-ung-dung-server-side-rendering-ssr">Authentication trong á»©ng dá»¥ng Server-Side Rendering (SSR)</h1>
<p>CÃ¡i thá»i mÃ  Razor Pages, Laravel hay Ruby on Rails cÃ²n thá»‘ng trá»‹ thÃ¬ má»i thá»© tháº­t Ä‘Æ¡n giáº£n.
Cáº£ quÃ¡ trÃ¬nh Ä‘Äƒng nháº­p gÃ³i gá»n trong vÃ i bÆ°á»›c:</p>
<ol>
<li>NgÆ°á»i dÃ¹ng báº¥m &quot;ÄÄƒng nháº­p&quot;, gá»­i username/password tá»›i server.</li>
<li>Server kiá»ƒm tra náº¿u thÃ´ng tin há»£p lá»‡ thÃ¬
táº¡o session vÃ  gá»­i láº¡i cookie cho browser. Cookie nÃ y cÃ³ flag <code>HttpOnly</code> Ä‘á»ƒ
JavaScript khÃ´ng Ä‘á»c Ä‘Æ°á»£c (cháº·n XSS).</li>
<li>Má»i request tiáº¿p theo browser Ä‘á»u tá»± Ä‘á»™ng gá»­i cookie Ä‘Ã³ theo, server chá»‰ viá»‡c kiá»ƒm tra session lÃ  xong.</li>
</ol>
<div class="mermaid">
sequenceDiagram
    participant User as Browser
    participant Server as SSR Server
<pre><code>User-&gt;&gt;Server: Gá»­i credentials (username/password)
Server--&gt;&gt;User: Táº¡o session, gá»­i HttpOnly cookie
Note right of User: Cookie HttpOnly, JS khÃ´ng thá»ƒ Ä‘á»c
User-&gt;&gt;Server: Gá»­i request tiáº¿p theo (tá»± Ä‘á»™ng kÃ¨m cookie)
Server--&gt;&gt;Server: Kiá»ƒm tra session
Server--&gt;&gt;User: Tráº£ HTML/data tÆ°Æ¡ng á»©ng
</code></pre>
</div>
<p>Authentication kiá»ƒu nÃ y ráº¥t an toÃ n vÃ¬ má»i thÃ´ng tin quan trá»ng Ä‘á»u náº±m á»Ÿ server
vÃ  cookie do browser náº¯m giá»¯ cÅ©ng khÃ´ng thá»ƒ truy cáº­p báº±ng Javascript.</p>
<p>Tuy nhiÃªn á»©ng dá»¥ng SSR Ä‘em láº¡i tráº£i nghiá»‡m ngÆ°á»i dÃ¹ng (UX) khÃ´ng tá»‘t. Cá»© má»—i láº§n chuyá»ƒn trang
lÃ  reload pháº£i chá» lÃ¢u, láº¡i cÃ²n máº¥t háº¿t state. Form Ä‘ang Ä‘iá»n dá»Ÿ thÃ¬ lá»¡ cÃ³ sá»± cá»‘ pháº£i reload láº¡i
lÃ  dá»¯ liá»‡u Ä‘Ã£ Ä‘iá»n máº¥t sáº¡ch thÃ¬ ngÆ°á»i dÃ¹ng chá»‰ muá»‘n... Ä‘Ã³ng tab vÃ  thá» khÃ´ng quay láº¡i ná»¯a ğŸ˜†</p>
<p>CÃ¡i UX tá»‡ háº¡i Ä‘Ã³ chÃ­nh lÃ  lÃ½ do SPA ra Ä‘á»i.</p>
<blockquote class="blockquote">
<p>âœ¨ Thá»±c ra, thá»i Ä‘Ã³ cÃ¡c website cÅ©ng Ä‘Ã£ cÃ³ AJAX cho phÃ©p cáº­p nháº­t dá»¯ liá»‡u mÃ  khÃ´ng reload
toÃ n trang. NhÆ°ng AJAX chá»‰ lÃ  má»™t miáº¿ng vÃ¡ giÃºp vÃ i pháº§n trÃªn trang mÆ°á»£t hÆ¡n, cÃ²n kiáº¿n trÃºc
tá»•ng thá»ƒ váº«n lÃ  server render, má»—i láº§n chuyá»ƒn trang váº«n pháº£i táº£i láº¡i HTML má»›i.</p>
</blockquote>
<h1 id="thoi-ai-thong-tri-cua-single-page-application-spa">Thá»i Ä‘áº¡i thá»‘ng trá»‹ cá»§a Single Page Application (SPA)</h1>
<p>Rá»“i React, Vue, Angular xuáº¥t hiá»‡n, má»i thá»© Ä‘á»u cháº¡y trong trÃ¬nh duyá»‡t.
KhÃ´ng cáº§n reload, khÃ´ng pháº£i chá» Ä‘á»£i, chá»‰ render láº¡i nhá»¯ng pháº§n cáº§n thiáº¿t.
Frontend giá» khÃ´ng chá»‰ render HTML mÃ  cÃ²n lÆ°u state.</p>
<p>ÄÃ¢y lÃ  luá»“ng Ä‘Äƒng nháº­p cá»§a á»©ng dá»¥ng SPA:</p>
<div class="mermaid">
sequenceDiagram
    participant User as Browser
    participant Api as API Server
<pre><code>User-&gt;&gt;Api: Gá»­i credentials (username/password) tá»›i login endpoint
Api--&gt;&gt;User: Tráº£ vá» access token
Note right of User: LÆ°u access token trong localStorage
User-&gt;&gt;Api: Gá»i API protected vá»›i Header Authorization: Bearer access_token
Api--&gt;&gt;User: Tráº£ dá»¯ liá»‡u
</code></pre>
</div>
<p>NhÆ°ng Ä‘á»ƒ gá»i API protected thÃ¬ á»©ng dá»¥ng SPA cáº§n má»™t thá»©: <strong>access token</strong>. VÃ  vÃ¬ browser náº±m
á»Ÿ phÃ­a ngÆ°á»i dÃ¹ng nÃªn <strong>access token</strong> khÃ´ng thá»ƒ Ä‘Æ°á»£c lÆ°u á»Ÿ má»™t chá»— nÃ o Ä‘Ã³ kÃ­n Ä‘Ã¡o khÃ´ng ai truy
cáº­p Ä‘Æ°á»£c. VÃ  token thÆ°á»ng Ä‘Æ°á»£c lÆ°u á»Ÿ <code>localStorage</code> hoáº·c <code>sessionStorage</code>.</p>
<p>VÃ¬ <code>localStorage</code> vÃ  <code>sessionStorage</code> cÃ³ thá»ƒ Ä‘á»™c Ä‘Æ°á»£c báº±ng Javascript nÃªn náº¿u
trang bá»‹ chÃ¨n script Ä‘á»™c thÃ¬ token cÃ³ thá»ƒ bá»‹ Ä‘Ã¡nh cáº¯p.</p>
<blockquote class="blockquote">
<p>âš ï¸ Váº¥n Ä‘á» cá»‘t lÃµi cá»§a SPA Authentication<br />
Token náº±m á»Ÿ phÃ­a client, nÆ¡i báº¡n khÃ´ng thá»ƒ tin tÆ°á»Ÿng tuyá»‡t Ä‘á»‘i.</p>
</blockquote>
<p><strong>NhÆ°ng cÃ¡c framework bÃ¢y giá» Ä‘á»u sanitize HTML rá»“i mÃ , sao váº«n sá»£ XSS?</strong></p>
<p>ÄÃºng lÃ  cÃ¡c framework ngÃ y nay nhÆ° React, Vue hay Angular Ä‘á»u sanitize HTML nÃªn
báº¡n khÃ´ng thá»ƒ dá»… dÃ ng vÃ o Ã´ comment rá»“i chÃ¨n Ä‘oáº¡n script Ä‘á»™c Ä‘Æ°á»£c ná»¯a. Tuy nhiÃªn á»©ng dá»¥ng váº«n
cÃ³ thá»ƒ bá»‹ táº¥n cÃ´ng XSS náº¿u:</p>
<ul>
<li>CÃ¡c thÆ° viá»‡n hoáº·c plugin cá»§a bÃªn thá»© ba cÃ³ thá»ƒ <strong>&quot;vÃ´ tÃ¬nh má»™t cÃ¡ch cá»‘ Ã½&quot;</strong> chÃ¨n script Ä‘á»™c.</li>
<li>Dev vÃ´ tÃ¬nh render <strong>HTML khÃ´ng kiá»ƒm soÃ¡t</strong> nhÆ° dÃ¹ng <code>dangerouslySetInnerHTML</code> trong React (kháº£ nÄƒng
nÃ y ráº¥t tháº¥p tuy nhiÃªn khÃ´ng pháº£i lÃ  0%).</li>
</ul>
<p><strong>Tháº¿ thÃ¬ lÆ°u token trong cookie thay vÃ¬ lÆ°u trong storage cÃ³ Ä‘Æ°á»£c khÃ´ng?</strong></p>
<p>HoÃ n toÃ n cÃ³ thá»ƒ, nhÆ°ng náº¿u báº¡n lÆ°u access token trong cookie
vÃ  gá»i API trá»±c tiáº¿p tá»« browser thÃ¬ trÃ¬nh duyá»‡t sáº½ <strong>tá»± Ä‘á»™ng gá»­i cookie kÃ¨m theo má»—i request</strong>,
ká»ƒ cáº£ request Ä‘Ã³ Ä‘áº¿n tá»« <strong>trang giáº£ máº¡o</strong> vÃ¬ cookie Ä‘Æ°á»£c gáº¯n theo domain, chá»© khÃ´ng theo origin cá»§a trang gá»i.
Äiá»u nÃ y sáº½ dáº«n tá»›i lá»— há»•ng báº£o máº­t khÃ¡c lÃ  <strong>CSRF (Cross-Site Request Forgery)</strong>.</p>
<p>VÃ­ dá»¥:
Báº¡n Ä‘ang Ä‘Äƒng nháº­p <code>mybank.com</code>, cookie session váº«n cÃ²n háº¡n.
Báº¡n truy cáº­p má»™t trang lÃ  <code>evil.com</code> cÃ³ tháº» <code>&lt;img src=&quot;https://mybank.com/api/transfer?to=attacker&quot;&gt;</code>.
TrÃ¬nh duyá»‡t khÃ´ng phÃ¢n biá»‡t Ä‘Æ°á»£c mÃ  gá»­i request vá»›i cookie xÃ¡c thá»±c cá»§a <code>mybank.com</code>
vÃ  tháº¿ lÃ  sá»‘ dÆ° cá»§a báº¡n khÃ´ng cÃ¡nh mÃ  bay.</p>
<blockquote class="blockquote">
<p>Báº¡n cÃ³ thá»ƒ Ä‘á»c thÃªm vá» CSRF táº¡i <a href="/post/sop-cors-va-csrf-khi-long-tin-bi-loi-dung">bÃ i viáº¿t nÃ y</a></p>
</blockquote>
<p><strong>SSR cÅ©ng dÃ¹ng cookie, sao khÃ´ng bá»‹ CSRF?</strong></p>
<p>ÄÃºng, SSR truyá»n thá»‘ng (Razor Pages, Laravel, Rails,...)
cÅ©ng dÃ¹ng cookie Ä‘á»ƒ giá»¯ session nÃªn váº«n cÃ³ nguy cÆ¡ bá»‹ CSRF. NhÆ°ng khÃ¡c á»Ÿ chá»— SSR
kiá»ƒm soÃ¡t toÃ n bá»™ UI vÃ  form render ra nÃªn cÃ³ thá»ƒ thÃªm anti-forgery token vÃ o form, cÃ²n SPA thÃ¬
khÃ´ng thá»ƒ nÃªn khÃ´ng thá»ƒ chá»‘ng CSRF (*) náº¿u chá»‰ dá»±a vÃ o cookie mÃ  khÃ´ng cÃ³ má»™t táº§ng trung gian hay
cÃ²n gá»i lÃ  Backend for Frontend (BFF) Ä‘á»ƒ xá»­ lÃ½ xÃ¡c thá»±c an toÃ n thay cho browser.</p>
<blockquote class="blockquote">
<p>(*) Viá»‡c thÃªm anti-forgery token vÃ o form trong SPA lÃ  vÃ´ nghÄ©a vÃ¬ token Ä‘Æ°á»£c táº¡o
trÃªn client nÃªn khÃ´ng thá»ƒ kiá»ƒm tra tÃ­nh há»£p lá»‡ táº¡i server.</p>
</blockquote>
<h2 id="roi-en-hybrid-next.js-remix-va-blazor">Rá»“i Ä‘áº¿n Hybrid: Next.js, Remix vÃ  Blazor</h2>
<p>NhÃ¬n láº¡i, SSR thÃ¬ an toÃ n nhÆ°ng Ä‘em láº¡i tráº£i nghiá»‡m tá»‡, SPA thÃ¬ mÆ°á»£t mÃ  nhÆ°ng báº£o máº­t kÃ©m.
CÃ¡c framework má»›i nhÆ° Next.js, Remix vÃ  gáº§n Ä‘Ã¢y lÃ  Blazor Web App
ra Ä‘á»i káº¿t há»£p Ä‘iá»ƒm máº¡nh cá»§a cáº£ hai:</p>
<ul>
<li>Tráº£i nghiá»‡m tuyá»‡t vá»i nhÆ° SPA.</li>
<li>Báº£o máº­t an toÃ n nhÆ° SSR.</li>
</ul>
<p>VÃ  Ä‘Ã³ chÃ­nh lÃ  lÃºc mÃ´ hÃ¬nh BFF (Backend for Frontend) xuáº¥t hiá»‡n nhÆ° má»™t ngÆ°á»i trung gian
Ä‘Ã¡ng tin cáº­y giá»¯a frontend vÃ  API. LÃºc nÃ y, Frontend khÃ´ng cÃ²n giá»¯ token ná»¯a mÃ 
má»i thá»© nháº¡y cáº£m Ä‘á»u náº±m á»Ÿ backend.</p>
<div class="mermaid">
sequenceDiagram
    participant Browser as Browser
    participant BFF as BFF Server
    participant API as API Server
<pre><code>Browser-&gt;&gt;BFF: Login â†’ gá»­i credentials (username/password)
BFF-&gt;&gt;BFF: XÃ¡c thá»±c credentials, táº¡o access token
Note right of BFF: Token chá»‰ náº±m á»Ÿ BFF, khÃ´ng gá»­i ra Browser
BFF--&gt;&gt;Browser: Tráº£ HttpOnly cookie
Browser-&gt;&gt;BFF: Gá»­i request API tiáº¿p theo (tá»± Ä‘á»™ng kÃ¨m cookie)
BFF-&gt;&gt;API: Gá»i API báº±ng token tháº­t
API--&gt;&gt;BFF: Response
BFF--&gt;&gt;Browser: Tráº£ HTML/data
Note right of BFF: BFF Ä‘Ã³ng vai trÃ² proxy giá»¯a Browser vÃ  API
</code></pre>
</div>
<p>Ã”ng nÃ y má»›i lÃ  ngÆ°á»i tháº­t sá»± cáº§m token vÃ  nÃ³i chuyá»‡n vá»›i API. Nhá» Ä‘Ã³ mÃ :</p>
<ul>
<li>KhÃ´ng cÃ²n chá»©a token trong <code>localStorage</code> nÃªn khÃ´ng lo bá»‹ XSS ná»¯a.</li>
<li>KhÃ´ng sá»£ CSRF khi cookie cÃ³ flag <code>SameSite</code> (**) vÃ  <code>HttpOnly</code>.</li>
<li>NgÆ°á»i dÃ¹ng váº«n cÃ³ tráº£i nghiá»‡m nhÆ° SPA.</li>
</ul>
<blockquote class="blockquote">
<p>(**) Cookie cÃ³ thá»ƒ Ä‘Æ°á»£c cáº¥u hÃ¬nh vá»›i flag <code>SameSite=Lax</code> hoáº·c <code>Strict</code> Ä‘á»ƒ ngÄƒn viá»‡c tá»± Ä‘á»™ng gá»­i
khi request tá»« trang khÃ¡c.</p>
</blockquote>
<p>TÃ³m láº¡i, BFF giÃºp cÃ¢n báº±ng giá»¯a báº£o máº­t vÃ  tráº£i nghiá»‡m ngÆ°á»i dÃ¹ng â€” Ä‘iá»u mÃ  SSR hay SPA thuáº§n tÃºy Ä‘á»u khÃ´ng lÃ m trá»n váº¹n.
á» <a href="/post/authentication-va-authorization-trong-blazor-phan-2-trien-khai-authentication-trong-blazor">pháº§n tiáº¿p theo</a>,
ta sáº½ Ä‘i sÃ¢u vÃ o cÃ¡ch Blazor Web App triá»ƒn khai mÃ´ hÃ¬nh nÃ y.</p>

</div>
