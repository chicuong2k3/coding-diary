name: Build and deploy to GitHub Pages

on:
    push:
        branches:
            - main

permissions:
    contents: write
    pages: write
    id-token: write

jobs:
    build_and_deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repo
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # needed so we can push back to main
                  persist-credentials: true

            - name: Setup .NET SDK
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: "10.0.x"

            - name: Install wasm-tools workload
              run: dotnet workload install wasm-tools

            - name: Restore & publish
              run: |
                  dotnet restore DocumentationWeb.sln
                  dotnet publish DocumentationWeb.csproj -c Release -o publish

            - name: Compute base href (project vs user site)
              id: basehref
              run: |
                  REPO_NAME="${{ github.event.repository.name }}"
                  OWNER="${{ github.repository_owner }}"
                  if [ "$REPO_NAME" = "${OWNER}.github.io" ]; then
                    echo "BASE_HREF=/"
                    echo "BASE_HREF=/" >> $GITHUB_OUTPUT
                  else
                    BASE="/${REPO_NAME}/"
                    echo "BASE_HREF=${BASE}"
                    echo "BASE_HREF=${BASE}" >> $GITHUB_OUTPUT
                  fi

            - name: Patch base href in ALL HTML files
              run: |
                  set -euo pipefail
                  export BASE_HREF="${{ steps.basehref.outputs.BASE_HREF }}"

                  echo "Patching all HTML files with base href: $BASE_HREF"

                  # Find all HTML files and patch them
                  find publish/wwwroot -name "*.html" -type f | while read -r HTML_FILE; do
                    echo "Patching: $HTML_FILE"

                    # Robust perl: slurp file, remove any existing <base ...> tag (case-insensitive),
                    # then insert a single <base href="$BASE_HREF" /> immediately after the opening <head> tag.
                    perl -0777 -i -pe '
                      s{(<head\b[^>]*>)(.*?)(</head>)}{
                        my $open=$1; my $inner=$2; my $close=$3;
                        $inner =~ s{<base\b[^>]*>}{}isi;
                        $open . "\n  <base href=\"$ENV{BASE_HREF}\" />" . $inner . $close
                      }sgei' "$HTML_FILE"
                  done

                  # Verify index.html was patched
                  INDEX="publish/wwwroot/index.html"
                  if [ -f "$INDEX" ]; then
                    echo "=== index.html after patch (head snippet) ==="
                    sed -n '1,30p' "$INDEX" || true

                    if ! grep -qi '<base' "$INDEX"; then
                      echo "::error::Base tag missing in index.html after patch"
                      exit 1
                    fi
                  else
                    echo "::warning::Index file not found at $INDEX"
                    exit 1
                  fi

                  # Count patched files
                  PATCHED_COUNT=$(find publish/wwwroot -name "*.html" -type f | wc -l)
                  echo "Patched $PATCHED_COUNT HTML files with base href: $BASE_HREF"

            - name: Fix absolute image/asset paths for GitHub Pages
              run: |
                  set -euo pipefail
                  export BASE_HREF="${{ steps.basehref.outputs.BASE_HREF }}"

                  # Skip if base href is just "/" (user site, no subfolder)
                  if [ "$BASE_HREF" = "/" ]; then
                    echo "Base href is /, no path fixing needed"
                    exit 0
                  fi

                  echo "Fixing absolute paths in HTML files for base href: $BASE_HREF"

                  # Fix absolute paths in HTML files:
                  # - /images/ -> ${BASE_HREF}images/
                  # - /css/ -> ${BASE_HREF}css/
                  # - /lib/ -> ${BASE_HREF}lib/
                  # - /_framework/ -> ${BASE_HREF}_framework/
                  # - /_content/ -> ${BASE_HREF}_content/
                  find publish/wwwroot -name "*.html" -type f | while read -r HTML_FILE; do
                    # Replace absolute paths with base-href-prefixed paths
                    # Using sed to replace src="/path" and href="/path" and url('/path')
                    sed -i \
                      -e "s|src=\"/images/|src=\"${BASE_HREF}images/|g" \
                      -e "s|src='/images/|src='${BASE_HREF}images/|g" \
                      -e "s|href=\"/images/|href=\"${BASE_HREF}images/|g" \
                      -e "s|href='/images/|href='${BASE_HREF}images/|g" \
                      -e "s|url('/images/|url('${BASE_HREF}images/|g" \
                      -e "s|url(\"/images/|url(\"${BASE_HREF}images/|g" \
                      -e "s|src=\"/css/|src=\"${BASE_HREF}css/|g" \
                      -e "s|href=\"/css/|href=\"${BASE_HREF}css/|g" \
                      -e "s|src=\"/lib/|src=\"${BASE_HREF}lib/|g" \
                      -e "s|href=\"/lib/|href=\"${BASE_HREF}lib/|g" \
                      -e "s|src=\"/favicon|src=\"${BASE_HREF}favicon|g" \
                      -e "s|href=\"/favicon|href=\"${BASE_HREF}favicon|g" \
                      "$HTML_FILE"
                  done

                  echo "Fixed absolute paths in all HTML files"

            - name: Create SPA 404 fallback
              # Copy the patched index.html to 404.html so GitHub Pages serves the SPA for deep links.
              run: |
                  set -euo pipefail
                  INDEX="publish/wwwroot/index.html"
                  FALLBACK="publish/wwwroot/404.html"
                  if [ -f "$INDEX" ]; then
                    cp "$INDEX" "$FALLBACK"
                    echo "Created $FALLBACK"
                  else
                    echo "::warning::Index file not found; cannot create 404.html"
                  fi

            - name: Ensure .nojekyll (prevent Jekyll from ignoring _framework)
              run: |
                  mkdir -p publish/wwwroot
                  touch publish/wwwroot/.nojekyll

            - name: Show index.html head (debug)
              run: |
                  echo "--- index.html head ---"
                  sed -n '1,120p' publish/wwwroot/index.html || true

            - name: Show publish contents
              run: |
                  ls -la publish/wwwroot | sed -n '1,200p'

            - name: Verify SPA fallback
              # Ensure publish/wwwroot/404.html exists and has the <base> tag so deep links work on GitHub Pages
              run: |
                  set -euo pipefail
                  FALLBACK="publish/wwwroot/404.html"
                  if [ ! -f "$FALLBACK" ]; then
                    echo "::error::Missing 404.html fallback"
                    ls -la publish/wwwroot | sed -n '1,200p'
                    exit 1
                  fi
                  if ! grep -qi '<base' "$FALLBACK"; then
                    echo "::error::404.html missing <base> tag"
                    sed -n '1,120p' "$FALLBACK" || true
                    exit 1
                  fi
                  echo "404.html present and contains base tag."

            - name: Smoke-check built assets
              run: |
                  echo "Checking key files exist in publish/wwwroot..."
                  set -euo pipefail
                  # Use wildcard presence checks because hashes can change
                  if ! ls publish/wwwroot/_framework/blazor.webassembly*.js 1>/dev/null 2>&1; then
                    echo "::error::Missing blazor.webassembly.*.js"
                    ls -la publish/wwwroot/_framework | sed -n '1,200p'
                    exit 1
                  fi
                  if ! ls publish/wwwroot/_content/Blazicons/Blazicons.*.bundle.scp.css 1>/dev/null 2>&1; then
                    echo "::error::Missing Blazicons CSS"
                    ls -la publish/wwwroot/_content/Blazicons | sed -n '1,200p'
                    exit 1
                  fi
                  echo "Smoke-check passed: key files present."

            # sitemap- name: Generate dynamic sitemap.xml
            #   run: |
            #     dotnet run --project Tools/SitemapGenerator/SitemapGenerator.csproj --output publish/wwwroot/sitemap.xml
            #   # If you use a different script or tool, adjust the command above accordingly

            - name: Deploy to main/docs (publish folder)
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  set -euo pipefail
                  echo "Preparing docs/ for deployment on branch 'main'"

                  git config user.name "github-actions[bot]"
                  git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

                  # Ensure we have the latest main
                  git fetch origin main
                  git checkout main

                  # Replace docs/ with publish output
                  rm -rf docs || true
                  mkdir -p docs
                  cp -a publish/wwwroot/. docs/

                  # ensure .nojekyll exists at site root
                  touch docs/.nojekyll

                  # Stage and commit changes
                  git add -A docs

                  if git diff --cached --quiet; then
                    echo "No changes to deploy"
                  else
                    git commit -m "Deploy: update docs from CI (publish/wwwroot)"
                    git push origin main
                  fi

# Notes:
# - This workflow writes deployment output into the `docs/` folder on `main` so GitHub Pages
#   can serve the site from main/docs (Settings → Pages → Source: main / docs).
# - Ensure Pages in the repository settings is configured to use the `main` branch and the
#   `/docs` folder as the publishing source after the workflow runs.
# - If your repo has branch protection on main, you might need a PAT (GH_PAGES_PAT) with
#   push permissions; adjust the git push command to use that token if necessary.
