name: Build and deploy to GitHub Pages

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0       # needed so we can push back to main
          persist-credentials: true

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Restore & publish
        run: |
          dotnet restore DocumentationWeb.sln
          dotnet publish DocumentationWeb.csproj -c Release -o publish

      - name: Compute base href (project vs user site)
        id: basehref
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          OWNER="${{ github.repository_owner }}"
          if [ "$REPO_NAME" = "${OWNER}.github.io" ]; then
            echo "BASE_HREF=/"
            echo "BASE_HREF=/" >> $GITHUB_OUTPUT
          else
            BASE="/${REPO_NAME}/"
            echo "BASE_HREF=${BASE}"
            echo "BASE_HREF=${BASE}" >> $GITHUB_OUTPUT
          fi

      - name: Patch index.html base href
        run: |
          set -euo pipefail
          export BASE_HREF="${{ steps.basehref.outputs.BASE_HREF }}"
          INDEX="publish/wwwroot/index.html"

          if [ -f "$INDEX" ]; then
            echo "=== index.html before patch (head snippet) ==="
            sed -n '1,120p' "$INDEX" || true

            # Backup for safety and investigation
            cp "$INDEX" "$INDEX.bak.$(date +%s)"
            ls -l "$INDEX" "$INDEX.bak."* || true

            # Robust perl: slurp file, remove any existing <base ...> tag (case-insensitive),
            # then insert a single <base href="$BASE_HREF" /> immediately after the opening <head> tag.
            perl -0777 -i -pe '
              s{(<head\b[^>]*>)(.*?)(</head>)}{
                my $open=$1; my $inner=$2; my $close=$3;
                $inner =~ s{<base\b[^>]*>}{}isi;
                $open . $inner . "\n  <base href=\"$ENV{BASE_HREF}\" />" . $close
              }sgei' "$INDEX"

            echo "=== index.html after patch (head snippet) ==="
            sed -n '1,120p' "$INDEX" || true

            # Ensure the base tag is present; fail early if not
            if ! grep -qi '<base' "$INDEX"; then
              echo "::error::Base tag missing after patch"
              exit 1
            fi
          else
            echo "::warning::Index file not found at $INDEX"
            exit 1
          fi

      - name: Ensure .nojekyll (prevent Jekyll from ignoring _framework)
        run: |
          mkdir -p publish/wwwroot
          touch publish/wwwroot/.nojekyll

      - name: Show index.html head (debug)
        run: |
          echo "--- index.html head ---"
          sed -n '1,120p' publish/wwwroot/index.html || true

      - name: Show publish contents
        run: |
          ls -la publish/wwwroot | sed -n '1,200p'

      - name: Rewrite root-relative links to include BASE_HREF
        run: |
          set -euo pipefail
          BASE_HREF="${{ steps.basehref.outputs.BASE_HREF }}"
          if [ "$BASE_HREF" = "/" ]; then
            echo "BASE_HREF is '/'; no rewrite needed"
            exit 0
          fi

          echo "Rewriting root-relative links to prefix with BASE_HREF=$BASE_HREF"

          # Find HTML/CSS/JS files and rewrite attributes that start with a single leading '/'
          # We avoid touching protocol-absolute or external URLs (http:, https:) and anchors (#).
          find publish/wwwroot -type f \( -name '*.html' -o -name '*.css' -o -name '*.js' \) -print0 |
            xargs -0 -n1 perl -0777 -i -pe '
              s{(\b(?:href|src|action)\s*=\s*)(["\'])/([^"'""'">\s]+)\2}{$1.$2.$ENV{BASE_HREF}.$3.$2}gise;
              # Also handle url(...) in CSS: url('/path') -> url('/BASE/path')
              s{(url\(\s*)(["\']?)/([^\)"\']+)(["\']?\s*\))}{$1.$2.$ENV{BASE_HREF}.$3.$4}gise;
            '

          echo "Rewrite complete. Sample changes (grep for rewritten hrefs):"
          grep -R --line-number --include='*.html' --include='*.css' --include='*.js' "${BASE_HREF#/}" publish/wwwroot || true

      - name: Smoke-check built assets
        run: |
          echo "Checking key files exist in publish/wwwroot..."
          set -euo pipefail
          # Use wildcard presence checks because hashes can change
          if ! ls publish/wwwroot/_framework/blazor.webassembly*.js 1>/dev/null 2>&1; then
            echo "::error::Missing blazor.webassembly.*.js"
            ls -la publish/wwwroot/_framework | sed -n '1,200p'
            exit 1
          fi
          if ! ls publish/wwwroot/_content/Blazicons/Blazicons.*.bundle.scp.css 1>/dev/null 2>&1; then
            echo "::error::Missing Blazicons CSS"
            ls -la publish/wwwroot/_content/Blazicons | sed -n '1,200p'
            exit 1
          fi
          echo "Smoke-check passed: key files present."

      - name: Deploy to main/docs (publish folder)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          echo "Preparing docs/ for deployment on branch 'main'"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Ensure we have the latest main
          git fetch origin main
          git checkout main

          # Replace docs/ with publish output
          rm -rf docs || true
          mkdir -p docs
          cp -a publish/wwwroot/. docs/

          # ensure .nojekyll exists at site root
          touch docs/.nojekyll

          # Stage and commit changes
          git add -A docs

          if git diff --cached --quiet; then
            echo "No changes to deploy"
          else
            git commit -m "Deploy: update docs from CI (publish/wwwroot)"
            git push origin main
          fi

# Notes:
# - This workflow writes deployment output into the `docs/` folder on `main` so GitHub Pages
#   can serve the site from main/docs (Settings → Pages → Source: main / docs).
# - Ensure Pages in the repository settings is configured to use the `main` branch and the
#   `/docs` folder as the publishing source after the workflow runs.
# - If your repo has branch protection on main, you might need a PAT (GH_PAGES_PAT) with
#   push permissions; adjust the git push command to use that token if necessary.
