name: Build and deploy to GitHub Pages

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Restore & publish
        run: |
          dotnet restore DocumentationWeb.sln
          dotnet publish DocumentationWeb.csproj -c Release -o publish

      - name: Compute base href (project vs user site)
        id: basehref
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          OWNER="${{ github.repository_owner }}"
          if [ "$REPO_NAME" = "${OWNER}.github.io" ]; then
            echo "BASE_HREF=/"
            echo "BASE_HREF=/" >> $GITHUB_OUTPUT
          else
            BASE="/${REPO_NAME}/"
            echo "BASE_HREF=${BASE}"
            echo "BASE_HREF=${BASE}" >> $GITHUB_OUTPUT
          fi

      - name: Patch index.html base href
        run: |
          BASE_HREF="${{ steps.basehref.outputs.BASE_HREF }}"
          INDEX="publish/wwwroot/index.html"
          if [ -f "$INDEX" ]; then
            if grep -q "<base href=" "$INDEX"; then
              perl -0777 -pe "s|<base href=\"[^\"]*\" */?>|<base href=\"${BASE_HREF}\" />|s" -i "$INDEX"
            else
              perl -0777 -pe "s|<head>|<head>\n    <base href=\"${BASE_HREF}\" />|s" -i "$INDEX"
            fi
          fi

      - name: Show publish contents
        run: |
          ls -la publish/wwwroot | sed -n '1,200p'

      - name: Deploy to gh-pages branch (peaceiris/actions-gh-pages)
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./publish/wwwroot
          publish_branch: gh-pages
          user_name: github-actions[bot]
          user_email: 41898282+github-actions[bot]@users.noreply.github.com
          allow_empty_commit: true
