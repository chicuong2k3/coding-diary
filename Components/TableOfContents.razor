@inject IJSRuntime JS
@implements IDisposable

<div class="toc-wrapper">
    <h4 class="toc-title">Mục Lục</h4>

    @if (_tocItems.Any())
    {
        <nav class="toc-nav">
            @foreach (var item in _tocItems)
            {
                <a href="#@item.Id"
                   class="toc-link @(item.Id == _activeId ? "active" : "")"
                   @onclick="() => ScrollToHeading(item.Id)"
                   @onclick:preventDefault>@item.Text</a>
            }
        </nav>
    }
</div>

@code {
    private List<TocItem> _tocItems = new();
    private string? _activeId;
    private DotNetObjectReference<TableOfContents>? _objRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _objRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("initToc", _objRef);
        }
    }

    private async Task ScrollToHeading(string id)
    {
        await JS.InvokeVoidAsync("scrollToHeading", id);
        _activeId = id;
        StateHasChanged();
    }

    [JSInvokable]
    public void UpdateTocItems(List<TocItem> items)
    {
        _tocItems = items;
        if (_tocItems.Any() && string.IsNullOrEmpty(_activeId))
        {
            _activeId = _tocItems.First().Id;
        }
        StateHasChanged();
    }

    [JSInvokable]
    public void SetActiveHeading(string? id)
    {
        if (_activeId != id)
        {
            _activeId = id;
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        _objRef?.Dispose();
    }

    public class TocItem
    {
        public string Id { get; set; } = "";
        public string Text { get; set; } = "";
        public int Level { get; set; }
    }
}
