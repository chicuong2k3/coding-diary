@inject NavigationManager Navigation

@{
    var currentSlug = GetCurrentSlug();
    var currentChapter = GetCurrentChapter();
    var currentBookName = currentChapter?.Tags.FirstOrDefault() ?? "";
}

@if (currentChapter != null)
{
    <div class="floating-bookmark">
        <button class="floating-bookmark-btn"
                data-bookmark-slug="@currentSlug"
                onclick="BookmarkManager.toggle('@currentSlug', '@EscapeJs(currentChapter.Title)', '@EscapeJs(currentBookName)')"
                title="Đánh dấu chương này (lưu vị trí đọc)">
            <span class="bookmark-icon-add">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z" />
                </svg>
            </span>
            <span class="bookmark-icon-remove" style="display:none;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z" />
                </svg>
            </span>
        </button>
    </div>
}

@code {
    private string GetCurrentSlug()
    {
        var path = Navigation.ToBaseRelativePath(Navigation.Uri).Split('?')[0].TrimEnd('/');
        return "/" + path;
    }

    private PageModel? GetCurrentChapter()
    {
        var rawPath = Navigation.ToBaseRelativePath(Navigation.Uri).Split('?')[0].TrimEnd('/');
        return GeneratedContentIndex.GetPages()
            .Where(p => !p.Draft)
            .FirstOrDefault(p => p.Slug.Trim('/').Equals(rawPath, StringComparison.OrdinalIgnoreCase));
    }

    private string EscapeJs(string input)
    {
        if (string.IsNullOrEmpty(input)) return "";
        return input.Replace("\\", "\\\\").Replace("'", "\\'").Replace("\n", "\\n").Replace("\r", "");
    }
}
