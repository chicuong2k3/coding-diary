@using Blake.Types

<div class="tag-cloud-container">
    <h3 class="tag-cloud-title">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/>
            <line x1="7" y1="7" x2="7.01" y2="7"/>
        </svg>
        Tags
    </h3>
    <div class="tag-cloud">
        @foreach (var tag in GetWeightedTags())
        {
            <a href="tags/@tag.Name.ToLowerInvariant()"
               class="tag-cloud-item"
               style="--tag-weight: @tag.Weight.ToString("F2", System.Globalization.CultureInfo.InvariantCulture);">
                <span class="tag-name">#@tag.Name</span>
                <span class="tag-count">@tag.Count</span>
            </a>
        }
    </div>
</div>

@code {
    private List<WeightedTag> GetWeightedTags()
    {
        var tagCounts = GeneratedContentIndex.GetPages()
            .Where(p => !p.Draft)
            .SelectMany(p => p.Tags)
            .GroupBy(tag => tag, StringComparer.OrdinalIgnoreCase)
            .ToDictionary(g => g.First(), g => g.Count());

        if (!tagCounts.Any())
            return new List<WeightedTag>();

        var maxCount = tagCounts.Values.Max();

        return tagCounts
            .Select(kvp => new WeightedTag
            {
                Name = kvp.Key,
                Count = kvp.Value,
                Weight = 0.85 + (kvp.Value / (double)maxCount * 0.35)
            })
            .OrderByDescending(t => t.Count)
            .ThenBy(t => t.Name)
            .ToList();
    }

    private class WeightedTag
    {
        public string Name { get; set; } = string.Empty;
        public int Count { get; set; }
        public double Weight { get; set; }
    }
}
