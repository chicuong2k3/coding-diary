@using Blake.Types
@inject NavigationManager Navigation

<div class="tag-cloud-container">
    <h3 class="tag-cloud-title">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/>
            <line x1="7" y1="7" x2="7.01" y2="7"/>
        </svg>
        Tags
    </h3>
    <div class="tag-cloud">
        @foreach (var tag in GetTags())
        {
            <button type="button"
                    class="tag-cloud-item @(IsSelected(tag.Name) ? "active" : "")"
                    @onclick="() => ToggleTag(tag.Name)">
                <span class="tag-name">#@tag.Name</span>
                <span class="tag-count">@tag.Count</span>
            </button>
        }
    </div>
    @if (_selectedTags.Any())
    {
        <button type="button" class="tag-clear-btn" @onclick="ClearSelection">
            Bỏ chọn tất cả
        </button>
    }
</div>

@code {
    private HashSet<string> _selectedTags = new(StringComparer.OrdinalIgnoreCase);

    private List<TagInfo> GetTags()
    {
        return GeneratedContentIndex.GetPages()
            .Where(p => !p.Draft)
            .SelectMany(p => p.Tags)
            .GroupBy(tag => tag, StringComparer.OrdinalIgnoreCase)
            .Select(g => new TagInfo { Name = g.First(), Count = g.Count() })
            .OrderByDescending(t => t.Count)
            .ThenBy(t => t.Name)
            .ToList();
    }

    private bool IsSelected(string tag) => _selectedTags.Contains(tag);

    private void ToggleTag(string tag)
    {
        if (_selectedTags.Contains(tag))
            _selectedTags.Remove(tag);
        else
            _selectedTags.Add(tag);

        NavigateToTags();
    }

    private void ClearSelection()
    {
        _selectedTags.Clear();
        Navigation.NavigateTo("tags");
    }

    private void NavigateToTags()
    {
        if (!_selectedTags.Any())
        {
            Navigation.NavigateTo("tags");
            return;
        }

        var query = string.Join("&", _selectedTags.Select(t => $"t={Uri.EscapeDataString(t)}"));
        Navigation.NavigateTo($"tags?{query}");
    }

    private class TagInfo
    {
        public string Name { get; set; } = string.Empty;
        public int Count { get; set; }
    }
}
