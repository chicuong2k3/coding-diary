@using Blake.Types
@using Blake.Generated

<div class="search-container" id="search-modal">
    <div class="search-overlay" onclick="closeSearch()"></div>
    <div class="search-modal">
        <div class="search-header">
            <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
            </svg>
            <input id="search-input"
                   class="search-input"
                   placeholder="Tìm chương, sách..."
                   oninput="handleSearchInput(this.value)"
                   onkeydown="handleSearchKeyDown(event)" />
            <div class="search-kbd">
                <kbd>ESC</kbd>
            </div>
            <button class="search-close" onclick="closeSearch()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <div class="search-body">
            <div id="search-results-container">
                <!-- Default: show popular books -->
                <div class="search-suggestions">
                    <div class="suggestions-label">Sách phổ biến</div>
                    <div class="tag-suggestions">
                        @foreach (var book in PopularBooks.Take(6))
                        {
                            <a href="book/@book.Slug" class="tag-suggestion" onclick="closeSearch()">
                                @book.Name
                            </a>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="search-footer">
            <div class="search-tips">
                <span><kbd>Enter</kbd> để tìm</span>
                <span><kbd>ESC</kbd> để thoát</span>
            </div>
        </div>
    </div>
</div>

<!-- Search data for JavaScript -->
<script id="search-data" type="application/json">
@(new MarkupString(System.Text.Json.JsonSerializer.Serialize(SearchData)))
</script>

<script>
    // Site Search Bridge to site.js
    document.addEventListener('DOMContentLoaded', function() {
        var modal = document.getElementById('search-modal');
        if (!modal) return;

        var observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    if (modal.classList.contains('open')) {
                        // site.js handles the rest
                    }
                }
            });
        });
        observer.observe(modal, { attributes: true });
    });
</script>

@code {
    private record BookItem(string Name, string Slug, int Count);
    private record SearchItem(string title, string url, string description, List<string> tags);

    private IEnumerable<BookItem> PopularBooks => GeneratedContentIndex.GetPages()
        .Where(p => !p.Draft && p.Tags.Any())
        .GroupBy(p => p.Tags.First(), StringComparer.OrdinalIgnoreCase)
        .OrderByDescending(g => g.Count())
        .Select(g => new BookItem(g.Key, g.Key.ToLower().Replace(" ", "-"), g.Count()));

    private IEnumerable<SearchItem> SearchData => GeneratedContentIndex.GetPages()
        .Where(p => !p.Draft)
        .Select(p => new SearchItem(
            p.Title,
            p.Slug.TrimStart('/'),
            p.Description,
            p.Tags.ToList()
        ));
}
