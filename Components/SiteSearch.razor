@using Blake.Types
@using Blake.Generated

<div class="search-container @(IsOpen ? "open" : "")">
    <div class="search-overlay" @onclick="Close"></div>
    <div class="search-modal">
        <div class="search-header">
            <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
            </svg>
            <input @ref="_inputRef"
                   value="@searchTerm"
                   @oninput="OnSearchInput"
                   @onkeydown="OnKeyDown"
                   class="search-input"
                   placeholder="Tìm bài viết..." />
            <div class="search-kbd">
                <kbd>ESC</kbd>
            </div>
            <button class="search-close" @onclick="Close">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <div class="search-body">
            @if (!string.IsNullOrWhiteSpace(searchTerm))
            {
                @if (searchResults.Any())
                {
                    <div class="search-results">
                        <div class="results-label">Kết quả</div>
                        @foreach (var result in searchResults.Take(8))
                        {
                            <a href="@result.Url" class="search-result" @onclick="Close">
                                <div class="result-icon">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                        <polyline points="14 2 14 8 20 8"/>
                                        <line x1="16" y1="13" x2="8" y2="13"/>
                                        <line x1="16" y1="17" x2="8" y2="17"/>
                                    </svg>
                                </div>
                                <div class="result-content">
                                    <div class="result-title">@result.Title</div>
                                    @if (!string.IsNullOrEmpty(result.Excerpt))
                                    {
                                        <div class="result-excerpt">@result.Excerpt</div>
                                    }
                                </div>
                                <div class="result-arrow">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="9 18 15 12 9 6"/>
                                    </svg>
                                </div>
                            </a>
                        }
                    </div>
                }
                else
                {
                    <div class="no-results">
                        <div class="no-results-icon">
                            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <circle cx="11" cy="11" r="8"/>
                                <path d="m21 21-4.35-4.35"/>
                                <line x1="8" y1="11" x2="14" y2="11"/>
                            </svg>
                        </div>
                        <p>Không có kết quả cho "<strong>@searchTerm</strong>"</p>
                        <span>Thử từ khóa khác</span>
                    </div>
                }
            }
            else
            {
                <div class="search-suggestions">
                    <div class="suggestions-label">Chủ đề phổ biến</div>
                    <div class="tag-suggestions">
                        @foreach (var tag in PopularTags.Take(6))
                        {
                            <button class="tag-suggestion" @onclick="() => SearchByTag(tag)">
                                #@tag
                            </button>
                        }
                    </div>
                </div>
            }
        </div>

        <div class="search-footer">
            <div class="search-tips">
                <span><kbd>Enter</kbd> để tìm</span>
                <span><kbd>ESC</kbd> để thoát</span>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public EventCallback<bool> IsOpenChanged { get; set; }

    private ElementReference _inputRef;
    private string searchTerm = string.Empty;
    private List<SearchResult> searchResults = new();

    private IEnumerable<string> PopularTags => GeneratedContentIndex.GetPages()
        .Where(p => !p.Draft)
        .SelectMany(p => p.Tags)
        .GroupBy(t => t, StringComparer.OrdinalIgnoreCase)
        .OrderByDescending(g => g.Count())
        .Select(g => g.Key);

    protected override async Task OnParametersSetAsync()
    {
        if (IsOpen)
        {
            searchTerm = string.Empty;
            searchResults.Clear();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (IsOpen)
        {
            try
            {
                await _inputRef.FocusAsync();
            }
            catch { }
        }
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? string.Empty;

        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            searchResults.Clear();
            return;
        }

        searchResults = SearchPages(searchTerm);
    }

    private void SearchByTag(string tag)
    {
        searchTerm = tag;
        searchResults = SearchPages(tag);
    }

    private async Task OnKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
        {
            await Close();
        }
    }

    private async Task Close()
    {
        searchTerm = string.Empty;
        searchResults.Clear();
        await IsOpenChanged.InvokeAsync(false);
    }

    private List<SearchResult> SearchPages(string term)
    {
        return GeneratedContentIndex.GetPages()
            .Where(p => !p.Draft)
            .Where(p => p.Title.Contains(term, StringComparison.OrdinalIgnoreCase) ||
                       p.Description.Contains(term, StringComparison.OrdinalIgnoreCase) ||
                       p.Tags.Any(t => t.Contains(term, StringComparison.OrdinalIgnoreCase)))
            .Select(p => new SearchResult
            {
                Title = p.Title,
                Url = p.Slug.TrimStart('/'),
                Excerpt = p.Description,
                Tags = p.Tags.ToList()
            })
            .OrderByDescending(r => CalculateRelevance(r, term))
            .ToList();
    }

    private double CalculateRelevance(SearchResult result, string term)
    {
        double score = 0;

        if (result.Title.Contains(term, StringComparison.OrdinalIgnoreCase))
            score += 10;

        if (result.Title.Equals(term, StringComparison.OrdinalIgnoreCase))
            score += 20;

        if (result.Tags.Any(t => t.Equals(term, StringComparison.OrdinalIgnoreCase)))
            score += 15;

        if (result.Tags.Any(t => t.Contains(term, StringComparison.OrdinalIgnoreCase)))
            score += 5;

        return score;
    }

    private class SearchResult
    {
        public string Title { get; set; } = string.Empty;
        public string Url { get; set; } = string.Empty;
        public string Excerpt { get; set; } = string.Empty;
        public List<string> Tags { get; set; } = new();
    }
}
